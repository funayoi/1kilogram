<html>
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="test/css" href="styles.css" />
  <script src="jquery-1.7.1.min.js"></script>
  <script src="loader.js"></script>
  <script>
    var access_token = "";

    $(document).ready(function(){
      var onWindowResize = function(){
        var boxWidth = 330;
        var newWidth = Math.floor(window.innerWidth / boxWidth) * boxWidth;
        $("#thumbnails").width(newWidth);
      };
      $(window).resize(onWindowResize);
      onWindowResize();


      var popupTabId;
      var loginTabCallback = function(tabId, changeInfo, tab) {
        if (tabId == popupTabId) {
          if (getAccessToken(tab.url)) {
            chrome.tabs.remove(tabId);
            chrome.tabs.onUpdated.removeListener(loginTabCallback);
            // ログイン処理
            updateSelfInfo();
            $("#login_menu,#user_menu").toggle();
          }
        }
      }
      var popupCallback = function(win) {
        console.debug(win);
        if (getAccessToken(win.tabs[0].url) == false) {
          popupTabId = win.tabs[0].id;
          chrome.tabs.onUpdated.addListener(loginTabCallback);
        }
      }
      $("a#login").click(function(){
        chrome.windows.create({url:loginURL, width:610, height:300, type:"popup"}, popupCallback);
      });

      function getAccessToken(url) {
        if (url.indexOf(callbackURLPrefix) == 0) {
          access_token = url.substring(callbackURLPrefix.length);
          console.debug(access_token);
          return true;
        } else {
          return false;
        }
      }

      $("a#test").click(function(){
        loadFeed();
/*        $.ajax({
          url: "https://api.instagram.com/v1/users/self/feed?access_token=" + access_token,
          dataType: "json",
          success: function(data, textStatus, jqXHR){console.debug(data)},
          error: function(jqXHR, textStatus, errorThrown){
            alert("error:" + textStatus);
          }
        });*/
      });

   });
  </script>
</head>
<body>

<header>
  <ul id="login_menu">
    <li><a id="login" href="#">login</a></li>
    <li><span>1 abv</span></li>
    <li><span>2 efg</span></li>
  </ul>
  <ul id="user_menu">
    <li><span id="username"></span></li>
  </ul>
</header>

<div id="main">
  <a id="test" href="#">test</a>

  <div id="thumbnails">
  </div>
</div>

</body>
</html>
